<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Boßel Wettkampfrechner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Optionale PWA-Tags (Manifest, Apple-Touch-Icon) -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  
  <!-- Firebase SDKs (Compat-Versionen) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2, h3 { margin: 10px 0; }
    .container { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    input, button, select { margin: 5px; padding: 5px; }
    .hidden { display: none; }
    .dropdownContainer { margin-bottom: 15px; }
    /* Tabelle für Runden */
    .table-container { overflow-x: auto; margin-top: 5px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #000; padding: 3px; text-align: center; }
    /* Ergebnis-Summary */
    .resultSummary { font-size: 0.9em; margin-top: 10px; }
    .groupHeader { font-weight: bold; margin-top: 20px; }
    /* Buttons (z. B. Führung togglen) */
    .toggleBtn { min-width: 80px; }
  </style>
</head>
<body>
  <h1>Boßel Wettkampfrechner</h1>
  
  <!-- Bereich: Wettkampf erstellen / beitreten -->
  <div id="competitionUI" class="container">
    <h2>Wettkampf erstellen</h2>
    <input type="text" id="compName" placeholder="Wettkampfname">
    <input type="password" id="compPassword" placeholder="Passwort">
    <button id="createCompBtn">Wettkampf erstellen</button>
    <br><br>
    <h2>ODER Wettkampf beitreten</h2>
    <input type="text" id="joinCompId" placeholder="Wettkampf ID">
    <input type="password" id="joinCompPassword" placeholder="Passwort">
    <button id="joinCompBtn">Beitreten</button>
    <div id="compMessage"></div>
  </div>
  
  <!-- Hauptbereich: Nach Erstellen/Beitreten -->
  <div id="mainUI" class="container hidden">
    <!-- Dropdown zur Auswahl der anzuzeigenden Gruppe -->
    <div class="dropdownContainer">
      <label for="groupSelect">Gruppe auswählen:</label>
      <select id="groupSelect">
        <option value="holz1">Holz 1</option>
        <option value="holz2">Holz 2</option>
        <option value="gummi1">Gummi 1</option>
        <option value="gummi2">Gummi 2</option>
      </select>
    </div>
    
    <!-- Detaillierte Ansicht der aktuell gewählten Gruppe -->
    <div id="detailedGroupContainer"></div>
    
    <!-- Zusammenfassung aller Gruppen (immer sichtbar) -->
    <div id="summaryContainer" class="resultSummary"></div>
  </div>
  
  <!-- Firebase- und App-Logik -->
  <script>
    /******** Firebase-Konfiguration ********/
    const firebaseConfig = {
      apiKey: "AIzaSyBj_ylDl8WgUnXbpwI1pfgWnvZSoQ9ML3A",
      authDomain: "wettkampf-f6f92.firebaseapp.com",
      databaseURL: "https://wettkampf-f6f92-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wettkampf-f6f92",
      storageBucket: "wettkampf-f6f92.firebasestorage.app",
      messagingSenderId: "161090727748",
      appId: "1:161090727748:web:33f4ff7ce4f6e5c08f7111",
      measurementId: "G-WCV2950HGK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    /******** Globale Variablen ********/
    const groups = [
      { id: "holz1", name: "Holz 1" },
      { id: "holz2", name: "Holz 2" },
      { id: "gummi1", name: "Gummi 1" },
      { id: "gummi2", name: "Gummi 2" }
    ];
    let currentCompId = null;      // Aktuelle Wettkampf-ID
    let groupStates = {};          // Aktuelle Zustände aller Gruppen (live)
    let selectedGroupId = "holz1"; // Standardmäßig wird "Holz 1" angezeigt
    
    /******** DOM-Elemente ********/
    const competitionUI = document.getElementById("competitionUI");
    const createCompBtn = document.getElementById("createCompBtn");
    const compNameInput = document.getElementById("compName");
    const compPasswordInput = document.getElementById("compPassword");
    const joinCompBtn = document.getElementById("joinCompBtn");
    const joinCompIdInput = document.getElementById("joinCompId");
    const joinCompPasswordInput = document.getElementById("joinCompPassword");
    const compMessageDiv = document.getElementById("compMessage");
    
    const mainUI = document.getElementById("mainUI");
    const groupSelect = document.getElementById("groupSelect");
    const detailedGroupContainer = document.getElementById("detailedGroupContainer");
    const summaryContainer = document.getElementById("summaryContainer");
    
    /******** Hilfsfunktionen ********/
    function generateCompId(length) {
      let result = '';
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    
    // Erzeugt den initialen Zustand einer Gruppe (analog zum Original-Wettkampfrechner)
    function createInitialGroupState() {
      return {
        topTeam: {
          verein: "",
          schoet: 0,
          meter: 0,
          leadership: false,
          checkboxes: Array(15).fill(false)
        },
        bottomTeam: {
          verein: "",
          schoet: 0,
          meter: 0,
          leadership: false,
          checkboxes: Array(15).fill(false)
        }
      };
    }
    
    /******** Wettkampferstellung/Beitritt ********/
    createCompBtn.addEventListener('click', () => {
      const name = compNameInput.value.trim();
      const pass = compPasswordInput.value.trim();
      if (!name || !pass) {
        alert("Bitte Wettkampfname und Passwort eingeben.");
        return;
      }
      const compId = generateCompId(6);
      let compData = {
        name: name,
        password: pass, // Hinweis: Für Produktion besser absichern!
        createdAt: Date.now(),
        groups: {}
      };
      groups.forEach(g => {
        compData.groups[g.id] = createInitialGroupState();
      });
      db.ref('competitions/' + compId).set(compData)
        .then(() => {
          compMessageDiv.innerHTML = `Wettkampf erstellt! ID: <strong></strong>`;
          enterCompetition(compId);
        })
        .catch(err => console.error("Fehler beim Erstellen:", err));
    });
    
    joinCompBtn.addEventListener('click', () => {
      const compId = joinCompIdInput.value.trim();
      const pass = joinCompPasswordInput.value.trim();
      if (!compId || !pass) {
        alert("Bitte Wettkampf-ID und Passwort eingeben.");
        return;
      }
      db.ref('competitions/' + compId).get()
        .then(snapshot => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            if (data.password === pass) {
              compMessageDiv.innerHTML = "Erfolgreich beigetreten!";
              enterCompetition(compId);
            } else {
              compMessageDiv.innerHTML = "Falsches Passwort.";
            }
          } else {
            compMessageDiv.innerHTML = "Wettkampf nicht gefunden.";
          }
        })
        .catch(err => console.error("Fehler beim Beitreten:", err));
    });
    
    // Nach erfolgreichem Erstellen/Beitreten
    function enterCompetition(compId) {
      currentCompId = compId;
      competitionUI.classList.add("hidden");
      mainUI.classList.remove("hidden");
      // Starte Live-Listener für alle Gruppen
      setupFirebaseListeners();
      // Standardmäßig detaillierte Ansicht für die aktuell ausgewählte Gruppe anzeigen
      renderDetailedGroup(selectedGroupId);
    }
    
    /******** Gruppenauswahl & Detaillierte Ansicht ********/
    // Dropdown-Änderung: Aktualisiere die Detailansicht
    groupSelect.addEventListener("change", e => {
      selectedGroupId = e.target.value;
      renderDetailedGroup(selectedGroupId);
    });
    
    // Rendert die detaillierte Ansicht der ausgewählten Gruppe
    function renderDetailedGroup(groupId) {
      // Erzeuge das HTML für den Detailbereich (Original-Oberfläche)
      detailedGroupContainer.innerHTML = getDetailedGroupHTML(groupId, getGroupName(groupId));
      // Setze Event-Listener für alle UI-Elemente dieser Gruppe
      setupDetailedEventListeners(groupId);
      // Falls es bereits einen Zustand gibt, aktualisiere die UI
      if (groupStates[groupId]) {
        updateDetailedUI(groupId, groupStates[groupId]);
      }
    }
    
    // Liefert den Gruppennamen anhand der ID
    function getGroupName(id) {
      const g = groups.find(gr => gr.id === id);
      return g ? g.name : "";
    }
    
    // Erzeugt das HTML der detaillierten Ansicht (Original-Oberfläche)
    function getDetailedGroupHTML(groupId, groupName) {
      // Erstelle die Tabelle für Top-Team
      let topTable = `<table><thead><tr><th>Runden</th>`;
      for (let i = 1; i <= 15; i++) { topTable += `<th></th>`; }
      topTable += `</tr></thead><tbody><tr>`;
      for (let i = 1; i <= 15; i++) { topTable += `<td><input type="checkbox" id="_top_cb"></td>`; }
      topTable += `</tr></tbody></table>`;
      
      // Tabelle für Bottom-Team
      let bottomTable = `<table><thead><tr><th>Runden</th>`;
      for (let i = 1; i <= 15; i++) { bottomTable += `<th></th>`; }
      bottomTable += `</tr></thead><tbody><tr>`;
      for (let i = 1; i <= 15; i++) { bottomTable += `<td><input type="checkbox" id="_bottom_cb"></td>`; }
      bottomTable += `</tr></tbody></table>`;
      
      return `
        <h2></h2>
        <div class="teamSection" id="_topSection">
          <h3>Team OBEN</h3>
          <button class="toggleBtn" id="_top_toggle">Führung</button>
          <input type="text" id="_top_verein" placeholder="Verein">
          <button id="_top_schoet">Schöööööt!</button>
          Schoet: <span id="_top_schoetDisplay">0</span>
          &nbsp;Meter: <input type="number" id="_top_meter" value="0">
          <div class="table-container"></div>
        </div>
        <div class="teamSection" id="_bottomSection">
          <h3>Team UNTEN</h3>
          <button class="toggleBtn" id="_bottom_toggle">Führung</button>
          <input type="text" id="_bottom_verein" placeholder="Verein">
          <button id="_bottom_schoet">Schöööööt!</button>
          Schoet: <span id="_bottom_schoetDisplay">0</span>
          &nbsp;Meter: <input type="number" id="_bottom_meter" value="0">
          <div class="table-container"></div>
        </div>
      `;
    }
    
    /******** Detaillierte Ansicht: Event-Listener und UI-Aktualisierung ********/
    function setupDetailedEventListeners(groupId) {
      // Top-Team
      const topToggle = document.getElementById(`_top_toggle`);
      const topVerein = document.getElementById(`_top_verein`);
      const topSchoetBtn = document.getElementById(`_top_schoet`);
      const topSchoetDisplay = document.getElementById(`_top_schoetDisplay`);
      const topMeter = document.getElementById(`_top_meter`);
      let topCheckboxes = [];
      for (let i = 1; i <= 15; i++) {
        topCheckboxes.push(document.getElementById(`_top_cb`));
      }
      // Bottom-Team
      const bottomToggle = document.getElementById(`_bottom_toggle`);
      const bottomVerein = document.getElementById(`_bottom_verein`);
      const bottomSchoetBtn = document.getElementById(`_bottom_schoet`);
      const bottomSchoetDisplay = document.getElementById(`_bottom_schoetDisplay`);
      const bottomMeter = document.getElementById(`_bottom_meter`);
      let bottomCheckboxes = [];
      for (let i = 1; i <= 15; i++) {
        bottomCheckboxes.push(document.getElementById(`_bottom_cb`));
      }
      
      // Funktion zum Speichern des Zustands in Firebase
      function saveState() {
        const state = {
          topTeam: {
            verein: topVerein.value,
            schoet: Number(topSchoetDisplay.textContent),
            meter: Number(topMeter.value),
            leadership: topToggle.classList.contains("active"),
            checkboxes: topCheckboxes.map(cb => cb.checked)
          },
          bottomTeam: {
            verein: bottomVerein.value,
            schoet: Number(bottomSchoetDisplay.textContent),
            meter: Number(bottomMeter.value),
            leadership: bottomToggle.classList.contains("active"),
            checkboxes: bottomCheckboxes.map(cb => cb.checked)
          }
        };
        db.ref('competitions/' + currentCompId + '/groups/' + groupId).set(state);
      }
      
      // Setze Event-Listener für alle UI-Elemente der detaillierten Ansicht
      topToggle.addEventListener("click", () => {
        topToggle.classList.toggle("active");
        topToggle.style.backgroundColor = topToggle.classList.contains("active") ? "green" : "";
        saveState();
      });
      bottomToggle.addEventListener("click", () => {
        bottomToggle.classList.toggle("active");
        bottomToggle.style.backgroundColor = bottomToggle.classList.contains("active") ? "green" : "";
        saveState();
      });
      topSchoetBtn.addEventListener("click", () => {
        topSchoetDisplay.textContent = Number(topSchoetDisplay.textContent) + 1;
        saveState();
      });
      bottomSchoetBtn.addEventListener("click", () => {
        bottomSchoetDisplay.textContent = Number(bottomSchoetDisplay.textContent) + 1;
        saveState();
      });
      topVerein.addEventListener("input", saveState);
      bottomVerein.addEventListener("input", saveState);
      topMeter.addEventListener("input", saveState);
      bottomMeter.addEventListener("input", saveState);
      topCheckboxes.forEach(cb => cb.addEventListener("change", saveState));
      bottomCheckboxes.forEach(cb => cb.addEventListener("change", saveState));
    }
    
    // Aktualisiert die UI der detaillierten Ansicht, wenn sich der Zustand ändert
    function updateDetailedUI(groupId, state) {
      if (!state) return;
      document.getElementById(`_top_verein`).value = state.topTeam.verein;
      document.getElementById(`_top_schoetDisplay`).textContent = state.topTeam.schoet;
      document.getElementById(`_top_meter`).value = state.topTeam.meter;
      const topToggle = document.getElementById(`_top_toggle`);
      if (state.topTeam.leadership) {
        topToggle.classList.add("active");
        topToggle.style.backgroundColor = "green";
      } else {
        topToggle.classList.remove("active");
        topToggle.style.backgroundColor = "";
      }
      for (let i = 1; i <= 15; i++) {
        document.getElementById(`_top_cb`).checked = state.topTeam.checkboxes[i-1];
      }
      document.getElementById(`_bottom_verein`).value = state.bottomTeam.verein;
      document.getElementById(`_bottom_schoetDisplay`).textContent = state.bottomTeam.schoet;
      document.getElementById(`_bottom_meter`).value = state.bottomTeam.meter;
      const bottomToggle = document.getElementById(`_bottom_toggle`);
      if (state.bottomTeam.leadership) {
        bottomToggle.classList.add("active");
        bottomToggle.style.backgroundColor = "green";
      } else {
        bottomToggle.classList.remove("active");
        bottomToggle.style.backgroundColor = "";
      }
      for (let i = 1; i <= 15; i++) {
        document.getElementById(`_bottom_cb`).checked = state.bottomTeam.checkboxes[i-1];
      }
    }
    
    /******** Firebase-Live-Listener und Summary ********/
    // Setzt Live-Listener für alle Gruppen und speichert Zustände in groupStates
    function setupFirebaseListeners() {
      groups.forEach(g => {
        db.ref('competitions/' + currentCompId + '/groups/' + g.id).on('value', snapshot => {
          const state = snapshot.val();
          if (state) {
            groupStates[g.id] = state;
            if (g.id === selectedGroupId) {
              updateDetailedUI(g.id, state);
            }
            updateSummaryUI();
          }
        });
      });
    }
    
    // Aktualisiert die Zusammenfassung aller Gruppen
    function updateSummaryUI() {
      let html = "<div class='groupHeader'>Ergebnisse aller Gruppen:</div>";
      groups.forEach(g => {
        const state = groupStates[g.id];
        if (state) {
          let schoetDiff = state.topTeam.schoet - state.bottomTeam.schoet;
          let meterDiff = Number(state.topTeam.meter) - Number(state.bottomTeam.meter);
          // Anpassung: Falls bottomTeam in Führung und Ergebnis positiv, -0.5, bzw. umgekehrt
          if (state.bottomTeam.leadership && schoetDiff > 0) {
            schoetDiff -= 0.5;
          } else if (state.topTeam.leadership && schoetDiff < 0) {
            schoetDiff += 0.5;
          }
          html += `<div>: Schoet  / Meter </div>`;
        } else {
          html += `<div>: keine Daten</div>`;
        }
      });
      summaryContainer.innerHTML = html;
    }
    
  </script>
</body>
</html>