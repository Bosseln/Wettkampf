<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wettkampf erstellen / beitreten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; }
    label { font-weight: bold; }
    input, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h1>Wettkampf erstellen / beitreten</h1>
  
  <!-- Bereich Wettkampf erstellen -->
  <div class="container">
    <h2>Wettkampf erstellen</h2>
    <label for="compName">Wettkampfname:</label>
    <input type="text" id="compName" placeholder="Wettkampfname"><br>
    <label for="compPassword">Passwort:</label>
    <input type="password" id="compPassword" placeholder="Passwort"><br>
    <button id="createCompBtn">Wettkampf erstellen</button>
  </div>
  
  <!-- Aktive Wettkämpfe -->
  <div class="container">
    <h2>Aktive Wettkämpfe</h2>
    <div id="activeCompetitions"></div>
  </div>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  <script>
    // Firebase-Konfiguration (bitte mit deinen eigenen Daten ersetzen)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Funktion zur Erzeugung einer zufälligen Wettkampf-ID
    function generateCompId(length) {
      let result = '';
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    
    // Wettkampf erstellen
    document.getElementById("createCompBtn").addEventListener("click", () => {
      const compName = document.getElementById("compName").value.trim();
      const compPassword = document.getElementById("compPassword").value;
      if (!compName || !compPassword) {
        alert("Bitte sowohl einen Wettkampfnamen als auch ein Passwort eingeben.");
        return;
      }
      const compId = generateCompId(6);
      const compData = {
        name: compName,
        password: compPassword,
        createdAt: Date.now()
      };
      db.ref('competitions/' + compId).set(compData, (error) => {
        if (error) {
          alert("Fehler beim Erstellen des Wettkampfs.");
        } else {
          alert("Wettkampf erstellt: " + compId);
          // Ersteller erhält sofort Schreibrechte
          window.location.href = "scoreboard.html?compId=" + encodeURIComponent(compId) + "&role=schreiber";
        }
      });
    });
    
    // Aktive Wettbewerbe laden
    function loadActiveCompetitions() {
      db.ref('competitions').on('value', snapshot => {
        const competitions = snapshot.val();
        const activeContainer = document.getElementById("activeCompetitions");
        activeContainer.innerHTML = "";
        if (competitions) {
          for (const compId in competitions) {
            const comp = competitions[compId];
            // Button für jeden aktiven Wettkampf
            const btn = document.createElement("button");
            btn.textContent = comp.name + " (" + compId + ")";
            btn.addEventListener("click", () => {
              joinCompetition(compId, comp);
            });
            activeContainer.appendChild(btn);
            activeContainer.appendChild(document.createElement("br"));
          }
        } else {
          activeContainer.textContent = "Keine aktiven Wettkämpfe gefunden.";
        }
      });
    }
    
    // Funktion, um einem Wettkampf beizutreten
    function joinCompetition(compId, comp) {
      const role = prompt("Möchtest du als 'zuschauer' oder 'schreiber' beitreten? (Bitte exakt eingeben)");
      if (!role) return;
      if (role.toLowerCase() === "zuschauer") {
        window.location.href = "scoreboard.html?compId=" + encodeURIComponent(compId) + "&role=zuschauer";
      } else if (role.toLowerCase() === "schreiber") {
        const enteredPassword = prompt("Bitte Passwort eingeben:");
        if (enteredPassword === comp.password) {
          window.location.href = "scoreboard.html?compId=" + encodeURIComponent(compId) + "&role=schreiber";
        } else {
          alert("Falsches Passwort.");
        }
      } else {
        alert("Ungültige Eingabe. Bitte 'zuschauer' oder 'schreiber' eingeben.");
      }
    }
    
    loadActiveCompetitions();
  </script>
</body>
</html>