<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Boßeln Scoreboard – Gummi 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    .team-header { color: #fff; padding: 10px; margin-bottom: 5px; }
    .red { background-color: red; }
    .green { background-color: green; }
    .table-container { overflow-x: auto; margin-bottom: 15px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #000; padding: 5px; text-align: center; }
    input[type="text"] { width: 100px; }
    input[type="number"] { width: 60px; }
    .score-area { margin: 10px 0; font-size: 1.1em; }
    #genderSelect { margin-left: 10px; margin-right: 10px; }
    button#backBtn { padding: 10px 15px; font-size: 1em; cursor: pointer; margin-top: 20px; display: block; }
    /* Der "-1" Button soll etwas kleiner sein */
    .removeSchoetBtn { padding: 5px 10px; font-size: 0.9em; margin-left: 5px; cursor: pointer; }
  </style>
</head>
<body>

<h1>Boßeln Scoreboard – Gummi 2</h1>

<!-- Geschlechtsauswahl -->
<div>
  <label for="genderSelect">Geschlecht:</label>
  <select id="genderSelect">
    <option value="men">Männer</option>
    <option value="women">Frauen</option>
  </select>
</div>

<br>

<!-- Oberes Team (Führung) -->
<div id="topTeam" class="team-header red">
  <button id="topTeamToggleBtn">Führung</button>
  <input type="text" id="topVerein" placeholder="Verein eintragen..." />
  <button id="topSchoetBtn">Schöööööt!</button>
  <button id="topRemoveSchoetBtn" class="removeSchoetBtn">-1</button>
  &nbsp;Schoet: <span id="topSchoetDisplay">0</span>
  &nbsp;Meter: <input type="number" id="topMeterInput" value="0" />
</div>

<!-- Tabelle für das obere Team -->
<div class="table-container">
  <table id="upperTable">
    <thead>
      <tr>
        <th>Runden</th>
        <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
        <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
        <th>11</th><th>12</th><th>13</th><th>14</th><th>15</th>
      </tr>
    </thead>
    <tbody>
      <!-- 5 Zeilen: Werfer 1, Werfer 2, Werfer 3, Werfer 4, Ersatz 1 -->
      <tr>
        <td><input type="text" id="gummi2_top_name0" placeholder="Werfer 1" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_1" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_2" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_3" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_4" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_5" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_6" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_7" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_8" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_9" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_10" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_11" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_12" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_13" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_14" /></td>
        <td><input type="checkbox" id="gummi2_top_cb0_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_top_name1" placeholder="Werfer 2" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_1" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_2" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_3" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_4" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_5" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_6" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_7" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_8" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_9" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_10" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_11" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_12" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_13" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_14" /></td>
        <td><input type="checkbox" id="gummi2_top_cb1_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_top_name2" placeholder="Werfer 3" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_1" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_2" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_3" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_4" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_5" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_6" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_7" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_8" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_9" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_10" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_11" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_12" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_13" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_14" /></td>
        <td><input type="checkbox" id="gummi2_top_cb2_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_top_name3" placeholder="Werfer 4" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_1" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_2" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_3" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_4" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_5" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_6" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_7" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_8" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_9" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_10" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_11" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_12" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_13" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_14" /></td>
        <td><input type="checkbox" id="gummi2_top_cb3_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_top_name4" placeholder="Ersatz 1" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_1" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_2" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_3" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_4" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_5" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_6" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_7" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_8" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_9" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_10" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_11" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_12" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_13" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_14" /></td>
        <td><input type="checkbox" id="gummi2_top_cb4_15" /></td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Unteres Team (Führung) – startet standardmäßig mit Führung (grün) -->
<div id="bottomTeam" class="team-header green">
  <button id="bottomTeamToggleBtn">Führung</button>
  <input type="text" id="bottomVerein" placeholder="Verein eintragen..." />
  <button id="bottomSchoetBtn">Schöööööt!</button>
  <button id="bottomRemoveSchoetBtn" class="removeSchoetBtn">-1</button>
  &nbsp;Schoet: <span id="bottomSchoetDisplay">0</span>
  &nbsp;Meter: <input type="number" id="bottomMeterInput" value="0" />
</div>

<!-- Tabelle für das untere Team -->
<div class="table-container">
  <table id="lowerTable">
    <thead>
      <tr>
        <th>Runden</th>
        <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
        <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
        <th>11</th><th>12</th><th>13</th><th>14</th><th>15</th>
      </tr>
    </thead>
    <tbody>
      <!-- 5 Zeilen für das untere Team -->
      <tr>
        <td><input type="text" id="gummi2_bottom_name0" placeholder="Werfer 1" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_1" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_2" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_3" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_4" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_5" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_6" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_7" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_8" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_9" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_10" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_11" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_12" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_13" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_14" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb0_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_bottom_name1" placeholder="Werfer 2" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_1" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_2" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_3" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_4" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_5" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_6" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_7" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_8" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_9" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_10" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_11" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_12" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_13" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_14" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb1_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_bottom_name2" placeholder="Werfer 3" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_1" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_2" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_3" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_4" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_5" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_6" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_7" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_8" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_9" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_10" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_11" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_12" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_13" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_14" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb2_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_bottom_name3" placeholder="Werfer 4" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_1" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_2" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_3" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_4" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_5" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_6" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_7" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_8" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_9" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_10" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_11" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_12" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_13" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_14" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb3_15" /></td>
      </tr>
      <tr>
        <td><input type="text" id="gummi2_bottom_name4" placeholder="Ersatz 1" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_1" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_2" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_3" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_4" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_5" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_6" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_7" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_8" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_9" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_10" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_11" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_12" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_13" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_14" /></td>
        <td><input type="checkbox" id="gummi2_bottom_cb4_15" /></td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Ergebnis-Anzeige -->
<div class="score-area">
  <strong>Ergebnis Schoet:</strong> <span id="ergebnisSchoet">0.0</span><br />
  <strong>Ergebnis Meter:</strong> <span id="ergebnisMeter">0</span>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
<script>
  // Lese die Wettkampfdaten aus der URL – für diese Datei gilt die Gruppe "gummi2"
  const params = new URLSearchParams(window.location.search);
  const compId = params.get("compId") || "Keine ID";
  // Für diese Datei ist die Gruppen-ID fest: gummi2
  const groupId = "gummi2";
  
  // Firebase-Konfiguration – ggf. anpassen
  const firebaseConfig = {
    apiKey: "AIzaSyBj_ylDl8WgUnXbpwI1pfgWnvZSoQ9ML3A",
    authDomain: "wettkampf-f6f92.firebaseapp.com",
    databaseURL: "https://wettkampf-f6f92-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "wettkampf-f6f92",
    storageBucket: "wettkampf-f6f92.firebasestorage.app",
    messagingSenderId: "161090727748",
    appId: "1:161090727748:web:33f4ff7ce4f6e5c08f7111",
    measurementId: "G-WCV2950HGK"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  // Exklusiver Zugriff: Lock‑Mechanismus mit Timeout
  const clientId = Date.now() + "_" + Math.floor(Math.random() * 1000000);
  const LOCK_TIMEOUT = 300000; // 5 Minuten
  const LOCK_REFRESH_INTERVAL = 120000; // 2 Minuten
  const lockRef = db.ref('competitions/' + compId + '/groups/' + groupId + '/lock');
  
  function acquireLock() {
    lockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        const lockData = snapshot.val();
        const now = Date.now();
        if (now - lockData.timestamp > LOCK_TIMEOUT) {
          console.log("Vorhandener Lock ist abgelaufen. Neuer Lock wird gesetzt.");
          setLock();
        } else {
          if (lockData.clientId === clientId) {
            console.log("Lock bereits von mir gesetzt.");
          } else {
            alert("Diese Scoreboard-Seite ist bereits in Benutzung. Bitte später erneut versuchen.");
            window.location.href = "scoreboard.html?compId=" + encodeURIComponent(compId);
          }
        }
      } else {
        setLock();
      }
    }).catch(error => {
      console.error("Fehler beim Prüfen des Locks:", error);
    });
  }
  
  function setLock() {
    lockRef.set({
      clientId: clientId,
      timestamp: Date.now()
    }).then(() => {
      console.log("Lock erfolgreich gesetzt.");
    }).catch(error => {
      console.error("Fehler beim Setzen des Locks:", error);
    });
  }
  
  function refreshLock() {
    lockRef.once('value').then(snapshot => {
      const lockData = snapshot.val();
      if (lockData && lockData.clientId === clientId) {
        lockRef.update({ timestamp: Date.now() })
          .then(() => { console.log("Lock-Refresh erfolgreich."); })
          .catch(error => { console.error("Fehler beim Aktualisieren des Locks:", error); });
      }
    });
  }
  
  function releaseLock() {
    lockRef.once('value').then(snapshot => {
      const lockData = snapshot.val();
      if (lockData && lockData.clientId === clientId) {
        lockRef.remove().then(() => { console.log("Lock freigegeben."); })
          .catch(error => { console.error("Fehler beim Freigeben des Locks:", error); });
      }
    });
  }
  
  acquireLock();
  const lockRefreshIntervalId = setInterval(refreshLock, LOCK_REFRESH_INTERVAL);
  window.addEventListener("beforeunload", function (e) {
    releaseLock();
    clearInterval(lockRefreshIntervalId);
  });
  
  // Element-Referenzen
  const topTeam = document.getElementById("topTeam");
  const bottomTeam = document.getElementById("bottomTeam");
  const topTeamToggleBtn = document.getElementById("topTeamToggleBtn");
  const bottomTeamToggleBtn = document.getElementById("bottomTeamToggleBtn");
  const topSchoetBtn = document.getElementById("topSchoetBtn");
  const bottomSchoetBtn = document.getElementById("bottomSchoetBtn");
  const topRemoveSchoetBtn = document.getElementById("topRemoveSchoetBtn");
  const bottomRemoveSchoetBtn = document.getElementById("bottomRemoveSchoetBtn");
  const topSchoetDisplay = document.getElementById("topSchoetDisplay");
  const bottomSchoetDisplay = document.getElementById("bottomSchoetDisplay");
  const topMeterInput = document.getElementById("topMeterInput");
  const bottomMeterInput = document.getElementById("bottomMeterInput");
  const ergebnisSchoet = document.getElementById("ergebnisSchoet");
  const ergebnisMeter = document.getElementById("ergebnisMeter");
  const genderSelect = document.getElementById("genderSelect");
  
  // Globale Variablen für Schöt-Zähler
  let topSchoet = 0;
  let bottomSchoet = 0;
  
  // Globale Zähler für die Checkboxen der letzten Messung
  let lastTopCount = 0;
  let lastBottomCount = 0;
  
  // Akkumulatoren für neue Haken
  let accumulatedDiffTop = 0;
  let accumulatedDiffBottom = 0;
  
  function countCheckboxes(tableId) {
    const table = document.getElementById(tableId);
    let count = 0;
    const inputs = table.querySelectorAll("input[type='checkbox']");
    inputs.forEach(input => { if (input.checked) count++; });
    return count;
  }
  
  function saveState() {
    const state = {
      topTeam: {
        verein: document.getElementById("topVerein").value,
        schoet: Number(topSchoetDisplay.textContent),
        meter: Number(topMeterInput.value),
        leadership: topTeam.classList.contains("green")
      },
      bottomTeam: {
        verein: document.getElementById("bottomVerein").value,
        schoet: Number(bottomSchoetDisplay.textContent),
        meter: Number(bottomMeterInput.value),
        leadership: bottomTeam.classList.contains("green")
      },
      resultSchoet: ergebnisSchoet.textContent,
      resultMeter: ergebnisMeter.textContent,
      gender: genderSelect.value,
      upperTable: saveTable("upperTable"),
      lowerTable: saveTable("lowerTable")
    };
    db.ref('competitions/' + compId + '/groups/' + groupId + '/scoreboard').set(state);
  }
  
  function saveTable(tableId) {
    const table = document.getElementById(tableId);
    let data = [];
    const rows = table.tBodies[0].rows;
    for (let i = 0; i < rows.length; i++) {
      let rowData = [];
      let row = rows[i];
      for (let j = 0; j < row.cells.length; j++) {
        let input = row.cells[j].querySelector("input");
        if (input) {
          if (input.type === "checkbox") {
            rowData.push(input.checked);
          } else {
            rowData.push(input.value);
          }
        } else {
          rowData.push(null);
        }
      }
      data.push(rowData);
    }
    return data;
  }
  
  function loadState() {
    db.ref('competitions/' + compId + '/groups/' + groupId + '/scoreboard').once('value')
      .then(snapshot => {
        const state = snapshot.val();
        if (state) {
          document.getElementById("topVerein").value = state.topTeam.verein || "";
          topSchoet = state.topTeam.schoet || 0;
          topSchoetDisplay.textContent = topSchoet;
          topMeterInput.value = state.topTeam.meter || 0;
          if (state.topTeam.leadership) {
            topTeam.classList.add("green");
            topTeam.classList.remove("red");
          } else {
            topTeam.classList.add("red");
            topTeam.classList.remove("green");
          }
          
          document.getElementById("bottomVerein").value = state.bottomTeam.verein || "";
          bottomSchoet = state.bottomTeam.schoet || 0;
          bottomSchoetDisplay.textContent = bottomSchoet;
          bottomMeterInput.value = state.bottomTeam.meter || 0;
          if (state.bottomTeam.leadership) {
            bottomTeam.classList.add("green");
            bottomTeam.classList.remove("red");
          } else {
            bottomTeam.classList.add("red");
            bottomTeam.classList.remove("green");
          }
          
          if (state.gender) { genderSelect.value = state.gender; }
          if (state.upperTable) { loadTable("upperTable", state.upperTable); }
          if (state.lowerTable) { loadTable("lowerTable", state.lowerTable); }
          ergebnisSchoet.textContent = state.resultSchoet || "0.0";
          ergebnisMeter.textContent = state.resultMeter || "0";
          
          lastTopCount = countCheckboxes("upperTable");
          lastBottomCount = countCheckboxes("lowerTable");
          accumulatedDiffTop = 0;
          accumulatedDiffBottom = 0;
          calculateResult();
        }
      })
      .catch(err => { console.error("Fehler beim Laden des Zustands:", err); });
  }
  
  function loadTable(tableId, data) {
    const table = document.getElementById(tableId);
    const rows = table.tBodies[0].rows;
    if (!data) return;
    for (let i = 0; i < rows.length && i < data.length; i++) {
      let row = rows[i];
      for (let j = 0; j < row.cells.length && j < data[i].length; j++) {
        let input = row.cells[j].querySelector("input");
        if (input) {
          if (input.type === "checkbox") {
            input.checked = data[i][j];
          } else {
            input.value = data[i][j];
          }
        }
      }
    }
  }
  
  function addTableInputListeners() {
    const inputs = document.querySelectorAll("input[type='checkbox']");
    inputs.forEach(input => {
      input.addEventListener("change", calculateResult);
    });
  }
  addTableInputListeners();
  
  function calculateResult() {
    const currentTopCount = countCheckboxes("upperTable");
    const currentBottomCount = countCheckboxes("lowerTable");
    const diffTop = currentTopCount - lastTopCount;
    const diffBottom = currentBottomCount - lastBottomCount;
    
    // Automatischer Führungswechsel: 
    if (topTeam.classList.contains("green")) {
      if (diffTop > 0) { accumulatedDiffTop += diffTop; }
      if (diffBottom > 0) { accumulatedDiffTop = 0; }
      if (accumulatedDiffTop >= 2) {
        topTeam.classList.remove("green");
        topTeam.classList.add("red");
        bottomTeam.classList.remove("red");
        bottomTeam.classList.add("green");
        accumulatedDiffTop = 0;
        accumulatedDiffBottom = 0;
      }
    } else {
      if (bottomTeam.classList.contains("green")) {
        if (diffBottom > 0) { accumulatedDiffBottom += diffBottom; }
        if (diffTop > 0) { accumulatedDiffBottom = 0; }
        if (accumulatedDiffBottom >= 2) {
          bottomTeam.classList.remove("green");
          bottomTeam.classList.add("red");
          topTeam.classList.remove("red");
          topTeam.classList.add("green");
          accumulatedDiffTop = 0;
          accumulatedDiffBottom = 0;
        }
      }
    }
    
    lastTopCount = currentTopCount;
    lastBottomCount = currentBottomCount;
    
    let meterDiff = parseInt(topMeterInput.value) - parseInt(bottomMeterInput.value);
    let threshold = (genderSelect.value === "men") ? 150 : 100;
    let extraSchoet = Math.floor(Math.abs(meterDiff) / threshold);
    if (meterDiff > 0) {
      meterDiff = meterDiff % threshold;
    } else if (meterDiff < 0) {
      meterDiff = - (Math.abs(meterDiff) % threshold);
    }
    
    const totalDiff = topSchoet - bottomSchoet;
    ergebnisSchoet.textContent = totalDiff.toFixed(1);
    ergebnisMeter.textContent = meterDiff.toFixed(0);
    
    saveState();
  }
  
  loadState();
  
  const backBtn = document.createElement("button");
  backBtn.textContent = "Zurück";
  backBtn.style.padding = "10px 15px";
  backBtn.style.fontSize = "1em";
  backBtn.style.cursor = "pointer";
  backBtn.addEventListener("click", () => {
    saveState();
    window.location.href = "scoreboard.html?compId=" + encodeURIComponent(compId);
  });
  document.body.appendChild(backBtn);
</script>
</body>
</html>