<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Scoreboard – Boßel Wettkampfrechner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Optionale PWA-Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  
  <!-- Firebase SDKs (Compat-Versionen) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2, h3 { margin: 10px 0; }
    .container { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    select, input, button { margin: 5px; padding: 5px; }
    .table-container { overflow-x: auto; margin-top: 10px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #000; padding: 5px; text-align: center; }
    .team-header { color: #fff; padding: 10px; margin-bottom: 5px; }
    .red { background-color: red; }
    .green { background-color: green; }
    .score-area { margin: 10px 0; font-size: 1.1em; }
    #genderSelect { margin-left: 10px; margin-right: 10px; }
    .resultSummary { font-size: 0.9em; margin-top: 20px; }
    .groupHeader { font-weight: bold; margin-top: 20px; }
    .toggleBtn { min-width: 80px; }
  </style>
</head>
<body>
  <h1>Scoreboard – Boßel Wettkampfrechner</h1>
  
  <!-- Anzeige der Wettkampf-ID (wichtig zum Beitreten) -->
  <div class="container">
    <strong>Wettkampf-ID:</strong> <span id="compIdDisplay"></span>
  </div>
  
  <!-- Dropdown zur Gruppenauswahl -->
  <div class="container">
    <label for="groupSelect">Gruppe auswählen:</label>
    <select id="groupSelect">
      <option value="holz1">Holz 1</option>
      <option value="holz2">Holz 2</option>
      <option value="gummi1">Gummi 1</option>
      <option value="gummi2">Gummi 2</option>
    </select>
  </div>
  
  <!-- Detaillierte Ansicht der ausgewählten Gruppe (vollständige Original-Oberfläche) -->
  <div class="container" id="detailedContainer"></div>
  
  <!-- Zusammenfassung aller Gruppen -->
  <div class="container resultSummary" id="summaryContainer"></div>
  
  <script>
    /******** Firebase-Konfiguration ********/
    const firebaseConfig = {
      apiKey: "AIzaSyBj_ylDl8WgUnXbpwI1pfgWnvZSoQ9ML3A",
      authDomain: "wettkampf-f6f92.firebaseapp.com",
      databaseURL: "https://wettkampf-f6f92-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wettkampf-f6f92",
      storageBucket: "wettkampf-f6f92.firebasestorage.app",
      messagingSenderId: "161090727748",
      appId: "1:161090727748:web:33f4ff7ce4f6e5c08f7111",
      measurementId: "G-WCV2950HGK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    /******** Wettkampf-ID aus URL lesen ********/
    function getCompIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("compId");
    }
    const compId = getCompIdFromUrl();
    if (!compId) {
      alert("Keine Wettkampf-ID gefunden!");
    }
    document.getElementById("compIdDisplay").textContent = compId;
    
    /******** Definition der Gruppen ********/
    const groups = [
      { id: "holz1", name: "Holz 1" },
      { id: "holz2", name: "Holz 2" },
      { id: "gummi1", name: "Gummi 1" },
      { id: "gummi2", name: "Gummi 2" }
    ];
    let groupStates = {};  // Hier werden die Zustände aller Gruppen live gespeichert
    let selectedGroup = "holz1";  // Standardmäßig wird "Holz 1" angezeigt
    
    /******** DOM-Elemente ********/
    const groupSelect = document.getElementById("groupSelect");
    const detailedContainer = document.getElementById("detailedContainer");
    const summaryContainer = document.getElementById("summaryContainer");
    
    groupSelect.value = selectedGroup;
    groupSelect.addEventListener("change", (e) => {
      selectedGroup = e.target.value;
      renderDetailedView(selectedGroup);
    });
    
    /******** Hilfsfunktionen ********/
    // Erzeugt den HTML-Code für eine vollständige Tabelle (5 Zeilen, 15 Spalten)
    function getFullTableHTML(prefix) {
      const rows = ["Werfer 1", "Werfer 2", "Werfer 3", "Werfer 4", "Ersatz 1"];
      let html = "<table><thead><tr><th>Werfer</th>";
      for (let i = 1; i <= 15; i++) {
        html += `<th></th>`;
      }
      html += "</tr></thead><tbody>";
      for (let r = 0; r < rows.length; r++) {
        html += "<tr>";
        html += `<td><input type="text" id="_name" placeholder=""></td>`;
        for (let c = 1; c <= 15; c++) {
          html += `<td><input type="checkbox" id="_cb_"></td>`;
        }
        html += "</tr>";
      }
      html += "</tbody></table>";
      return html;
    }
    
    // Erzeugt den HTML-Code der detaillierten Ansicht einer Gruppe (Original-Oberfläche)
    function getDetailedHTML(groupId, groupName) {
      return `
        <h2> – Detaillierte Ansicht</h2>
        <div id="_topTeam" class="team-header red">
          <button class="toggleBtn" id="_top_toggle">Führung</button>
          <input type="text" id="_top_verein" placeholder="Verein eintragen...">
          <button id="_top_schoet">Schöööööt!</button>
          &nbsp;Schoet: <span id="_top_schoetDisplay">0</span>
          &nbsp;Meter: <input type="number" id="_top_meter" value="0">
        </div>
        <div class="table-container">
          
        </div>
        <div id="_bottomTeam" class="team-header green">
          <button class="toggleBtn" id="_bottom_toggle">Führung</button>
          <input type="text" id="_bottom_verein" placeholder="Verein eintragen...">
          <button id="_bottom_schoet">Schöööööt!</button>
          &nbsp;Schoet: <span id="_bottom_schoetDisplay">0</span>
          &nbsp;Meter: <input type="number" id="_bottom_meter" value="0">
        </div>
        <div class="table-container">
          
        </div>
        <div class="score-area">
          <strong>Ergebnis Schoet:</strong> <span id="_ergebnisSchoet">0.0</span><br>
          <strong>Ergebnis Meter:</strong> <span id="_ergebnisMeter">0</span>
        </div>
      `;
    }
    
    // Rendert die detaillierte Ansicht der ausgewählten Gruppe
    function renderDetailedView(groupId) {
      const groupName = groups.find(g => g.id === groupId).name;
      detailedContainer.innerHTML = getDetailedHTML(groupId, groupName);
      setupDetailedListeners(groupId);
      if (groupStates[groupId]) {
        updateDetailedUI(groupId, groupStates[groupId]);
      }
    }
    
    /******** Detaillierte Ansicht: Event-Listener und UI-Aktualisierung ********/
    function setupDetailedListeners(groupId) {
      // OBEN
      const topToggle = document.getElementById(`_top_toggle`);
      const topVerein = document.getElementById(`_top_verein`);
      const topSchoetBtn = document.getElementById(`_top_schoet`);
      const topSchoetDisplay = document.getElementById(`_top_schoetDisplay`);
      const topMeter = document.getElementById(`_top_meter`);
      let topNames = [];
      let topCheckboxes = [];
      for (let r = 0; r < 5; r++) {
        topNames.push(document.getElementById(`_top_name`));
        let row = [];
        for (let c = 1; c <= 15; c++) {
          row.push(document.getElementById(`_top_cb_`));
        }
        topCheckboxes.push(row);
      }
      // UNTEN
      const bottomToggle = document.getElementById(`_bottom_toggle`);
      const bottomVerein = document.getElementById(`_bottom_verein`);
      const bottomSchoetBtn = document.getElementById(`_bottom_schoet`);
      const bottomSchoetDisplay = document.getElementById(`_bottom_schoetDisplay`);
      const bottomMeter = document.getElementById(`_bottom_meter`);
      let bottomNames = [];
      let bottomCheckboxes = [];
      for (let r = 0; r < 5; r++) {
        bottomNames.push(document.getElementById(`_bottom_name`));
        let row = [];
        for (let c = 1; c <= 15; c++) {
          row.push(document.getElementById(`_bottom_cb_`));
        }
        bottomCheckboxes.push(row);
      }
      
      function saveState() {
        const topState = {
          verein: topVerein.value,
          schoet: Number(topSchoetDisplay.textContent),
          meter: Number(topMeter.value),
          leadership: topToggle.classList.contains("active"),
          names: topNames.map(input => input.value),
          checkboxes: topCheckboxes.map(row => row.map(cb => cb.checked))
        };
        const bottomState = {
          verein: bottomVerein.value,
          schoet: Number(bottomSchoetDisplay.textContent),
          meter: Number(bottomMeter.value),
          leadership: bottomToggle.classList.contains("active"),
          names: bottomNames.map(input => input.value),
          checkboxes: bottomCheckboxes.map(row => row.map(cb => cb.checked))
        };
        db.ref('competitions/' + compId + '/groups/' + groupId).set({
          topTeam: topState,
          bottomTeam: bottomState
        });
        calculateAndDisplayResult(groupId);
      }
      
      topToggle.addEventListener("click", () => {
        topToggle.classList.toggle("active");
        topToggle.style.backgroundColor = topToggle.classList.contains("active") ? "green" : "";
        saveState();
      });
      bottomToggle.addEventListener("click", () => {
        bottomToggle.classList.toggle("active");
        bottomToggle.style.backgroundColor = bottomToggle.classList.contains("active") ? "green" : "";
        saveState();
      });
      topSchoetBtn.addEventListener("click", () => {
        topSchoetDisplay.textContent = Number(topSchoetDisplay.textContent) + 1;
        saveState();
      });
      bottomSchoetBtn.addEventListener("click", () => {
        bottomSchoetDisplay.textContent = Number(bottomSchoetDisplay.textContent) + 1;
        saveState();
      });
      topVerein.addEventListener("input", saveState);
      bottomVerein.addEventListener("input", saveState);
      topMeter.addEventListener("input", saveState);
      bottomMeter.addEventListener("input", saveState);
      topNames.forEach(input => input.addEventListener("input", saveState));
      bottomNames.forEach(input => input.addEventListener("input", saveState));
      topCheckboxes.forEach(row => row.forEach(cb => cb.addEventListener("change", saveState)));
      bottomCheckboxes.forEach(row => row.forEach(cb => cb.addEventListener("change", saveState)));
    }
    
    function updateDetailedUI(groupId, state) {
      if (!state) return;
      document.getElementById(`_top_verein`).value = state.topTeam.verein;
      document.getElementById(`_top_schoetDisplay`).textContent = state.topTeam.schoet;
      document.getElementById(`_top_meter`).value = state.topTeam.meter;
      const topToggle = document.getElementById(`_top_toggle`);
      if (state.topTeam.leadership) {
        topToggle.classList.add("active");
        topToggle.style.backgroundColor = "green";
      } else {
        topToggle.classList.remove("active");
        topToggle.style.backgroundColor = "";
      }
      for (let r = 0; r < 5; r++) {
        document.getElementById(`_top_name`).value = state.topTeam.names[r] || "";
        for (let c = 1; c <= 15; c++) {
          document.getElementById(`_top_cb_`).checked = state.topTeam.checkboxes[r][c-1];
        }
      }
      document.getElementById(`_bottom_verein`).value = state.bottomTeam.verein;
      document.getElementById(`_bottom_schoetDisplay`).textContent = state.bottomTeam.schoet;
      document.getElementById(`_bottom_meter`).value = state.bottomTeam.meter;
      const bottomToggle = document.getElementById(`_bottom_toggle`);
      if (state.bottomTeam.leadership) {
        bottomToggle.classList.add("active");
        bottomToggle.style.backgroundColor = "green";
      } else {
        bottomToggle.classList.remove("active");
        bottomToggle.style.backgroundColor = "";
      }
      for (let r = 0; r < 5; r++) {
        document.getElementById(`_bottom_name`).value = state.bottomTeam.names[r] || "";
        for (let c = 1; c <= 15; c++) {
          document.getElementById(`_bottom_cb_`).checked = state.bottomTeam.checkboxes[r][c-1];
        }
      }
    }
    
    function calculateAndDisplayResult(groupId) {
      const topMeter = document.getElementById(`_top_meter`).value;
      const bottomMeter = document.getElementById(`_bottom_meter`).value;
      const topSchoet = Number(document.getElementById(`_top_schoetDisplay`).textContent);
      const bottomSchoet = Number(document.getElementById(`_bottom_schoetDisplay`).textContent);
      
      let meterDiff = parseInt(topMeter) - parseInt(bottomMeter);
      let schoeetDiff = topSchoet - bottomSchoet;
      
      const gender = document.getElementById("genderSelect").value;
      const threshold = (gender === "men") ? 150 : 100;
      
      const absMeterDiff = Math.abs(meterDiff);
      const extraSchoet = Math.floor(absMeterDiff / threshold);
      
      if (meterDiff > 0) {
        schoeetDiff += extraSchoet;
        meterDiff = meterDiff % threshold;
      } else if (meterDiff < 0) {
        schoeetDiff -= extraSchoet;
        const leftover = absMeterDiff % threshold;
        meterDiff = -leftover;
      }
      
      if (document.getElementById(`_bottom_toggle`).classList.contains("active") && schoeetDiff > 0) {
        schoeetDiff -= 0.5;
      } else if (document.getElementById(`_top_toggle`).classList.contains("active") && schoeetDiff < 0) {
        schoeetDiff += 0.5;
      }
      
      document.getElementById(`_ergebnisSchoet`).textContent = schoeetDiff.toFixed(1);
      document.getElementById(`_ergebnisMeter`).textContent = meterDiff.toFixed(0);
    }
    
    /******** Firebase Live-Listener und Summary ********/
    function setupFirebaseListeners() {
      groups.forEach(g => {
        db.ref('competitions/' + compId + '/groups/' + g.id).on('value', snapshot => {
          const state = snapshot.val();
          if (state) {
            groupStates[g.id] = state;
            if (g.id === selectedGroup) {
              updateDetailedUI(g.id, state);
            }
            updateSummary();
          }
        });
      });
    }
    
    function updateSummary() {
      let html = "<div class='groupHeader'>Ergebnisse aller Gruppen:</div>";
      groups.forEach(g => {
        const state = groupStates[g.id];
        if (state) {
          let schDiff = state.topTeam.schoet - state.bottomTeam.schoet;
          let metDiff = Number(state.topTeam.meter) - Number(state.bottomTeam.meter);
          if (state.bottomTeam.leadership && schDiff > 0) { schDiff -= 0.5; }
          else if (state.topTeam.leadership && schDiff < 0) { schDiff += 0.5; }
          let leadingClub = "";
          if (state.topTeam.schoet > state.bottomTeam.schoet) {
            leadingClub = state.topTeam.verein || "Team OBEN";
          } else if (state.topTeam.schoet < state.bottomTeam.schoet) {
            leadingClub = state.bottomTeam.verein || "Team UNTEN";
          } else {
            leadingClub = "gleichstand";
          }
          html += `<div>: Schoet Differenz  / Meter . Führung: </div>`;
        } else {
          html += `<div>: keine Daten</div>`;
        }
      });
      summaryContainer.innerHTML = html;
    }
    
    // Starte Firebase-Live-Listener und rendere initial die detaillierte Ansicht der Standardgruppe
    setupFirebaseListeners();
    renderDetailedView(selectedGroup);
  </script>
</body>
</html>