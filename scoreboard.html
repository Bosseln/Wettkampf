<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Scoreboard – Boßel Wettkampfrechner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Optionale PWA-Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  
  <!-- Firebase SDKs (Compat-Versionen) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database-compat.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2, h3 { margin: 10px 0; }
    .container { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    select, input, button { margin: 5px; padding: 5px; }
    .table-container { overflow-x: auto; margin-top: 10px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #000; padding: 5px; text-align: center; }
    .team-header { color: #fff; padding: 10px; margin-bottom: 5px; }
    .red { background-color: red; }
    .green { background-color: green; }
    .score-area { margin: 10px 0; font-size: 1.1em; }
    #genderSelect { margin-left: 10px; margin-right: 10px; }
    .resultSummary { font-size: 0.9em; margin-top: 20px; }
    .groupHeader { font-weight: bold; margin-top: 20px; }
    .toggleBtn { min-width: 80px; }
  </style>
</head>
<body>
  <h1>Scoreboard – Boßel Wettkampfrechner</h1>
  
  <!-- Anzeige der Wettkampf-ID -->
  <div class="container">
    <strong>Wettkampf-ID:</strong> <span id="compIdDisplay"></span>
  </div>
  
  <!-- Dropdown zur Gruppenauswahl -->
  <div class="container">
    <label for="groupSelect">Gruppe auswählen:</label>
    <select id="groupSelect">
      <option value="holz1">Holz 1</option>
      <option value="holz2">Holz 2</option>
      <option value="gummi1">Gummi 1</option>
      <option value="gummi2">Gummi 2</option>
    </select>
  </div>
  
  <!-- Container für die detaillierte Scoreboard-Oberfläche -->
  <div class="container" id="scoreboardContainer"></div>
  
  <!-- Zusammenfassung aller Gruppen -->
  <div class="container resultSummary" id="summaryContainer"></div>
  
  <script>
    /******** Firebase-Konfiguration ********/
    const firebaseConfig = {
      apiKey: "AIzaSyBj_ylDl8WgUnXbpwI1pfgWnvZSoQ9ML3A",
      authDomain: "wettkampf-f6f92.firebaseapp.com",
      databaseURL: "https://wettkampf-f6f92-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wettkampf-f6f92",
      storageBucket: "wettkampf-f6f92.firebasestorage.app",
      messagingSenderId: "161090727748",
      appId: "1:161090727748:web:33f4ff7ce4f6e5c08f7111",
      measurementId: "G-WCV2950HGK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    /******** Wettkampf-ID aus URL lesen ********/
    function getCompIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("compId");
    }
    const compId = getCompIdFromUrl();
    if (!compId) { alert("Keine Wettkampf-ID gefunden!"); }
    document.getElementById("compIdDisplay").textContent = compId;
    
    /******** Definition der Gruppen ********/
    const groups = [
      { id: "holz1", name: "Holz 1" },
      { id: "holz2", name: "Holz 2" },
      { id: "gummi1", name: "Gummi 1" },
      { id: "gummi2", name: "Gummi 2" }
    ];
    let groupStates = {}; // Hier werden die Zustände aller Gruppen live gespeichert
    let selectedGroup = "holz1"; // Standardmäßig "Holz 1"
    
    /******** DOM-Elemente ********/
    const groupSelect = document.getElementById("groupSelect");
    const scoreboardContainer = document.getElementById("scoreboardContainer");
    const summaryContainer = document.getElementById("summaryContainer");
    
    groupSelect.value = selectedGroup;
    groupSelect.addEventListener("change", (e) => {
      selectedGroup = e.target.value;
      renderScoreboard(selectedGroup);
    });
    
    /******** Originale Scoreboard-Oberfläche (genau wie von dir gesendet) ********/
    // Diese Funktion gibt den HTML-Code der Originaloberfläche zurück,
    // wobei alle Element-IDs mit dem Präfix (groupId + "_") versehen werden.
    function getScoreboardHTML(groupId) {
      return `
      <!-- Oberes Team (Führung) -->
      <div id="_topTeam" class="team-header red">
        <button id="_topTeamToggleBtn">Führung</button>
        <input type="text" id="_topVerein" placeholder="Verein eintragen..." />
        <button id="_topSchoetBtn">Schöööööt!</button>
        &nbsp;Schoet: <span id="_topSchoetDisplay">0</span>
        &nbsp;Meter: <input type="number" id="_topMeterInput" value="0" />
      </div>
      
      <!-- Tabelle mit Runden, Werfern, Checkboxen -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Runden</th>
              <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
              <th>6</th><th>7</th><th>8</th><th>9</th><th>10</th>
              <th>11</th><th>12</th><th>13</th><th>14</th><th>15</th>
            </tr>
          </thead>
          <tbody>
            <!-- Oberes Team: 5 Zeilen (Werfer 1-4 und Ersatz 1) -->
            <tr>
              <td><input type="text" id="_topWerfer1" placeholder="Werfer 1" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_top_cb1_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_topWerfer2" placeholder="Werfer 2" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_top_cb2_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_topWerfer3" placeholder="Werfer 3" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_top_cb3_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_topWerfer4" placeholder="Werfer 4" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_top_cb4_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_topErsatz1" placeholder="Ersatz 1" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_top_cb5_"></td>`).join('')}
            </tr>
            <!-- Unteres Team: 5 Zeilen (Werfer 1-4 und Ersatz 1) -->
            <tr>
              <td><input type="text" id="_bottomWerfer1" placeholder="Werfer 1" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_bottom_cb1_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_bottomWerfer2" placeholder="Werfer 2" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_bottom_cb2_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_bottomWerfer3" placeholder="Werfer 3" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_bottom_cb3_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_bottomWerfer4" placeholder="Werfer 4" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_bottom_cb4_"></td>`).join('')}
            </tr>
            <tr>
              <td><input type="text" id="_bottomErsatz1" placeholder="Ersatz 1" /></td>
              ${[...Array(15)].map((_,i) => `<td><input type="checkbox" id="_bottom_cb5_"></td>`).join('')}
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Unteres Team (Führung) -->
      <div id="_bottomTeam" class="team-header green">
        <button id="_bottomTeamToggleBtn">Führung</button>
        <input type="text" id="_bottomVerein" placeholder="Verein eintragen..." />
        <button id="_bottomSchoetBtn">Schöööööt!</button>
        &nbsp;Schoet: <span id="_bottomSchoetDisplay">0</span>
        &nbsp;Meter: <input type="number" id="_bottomMeterInput" value="0" />
      </div>
      
      <!-- Ergebnis-Anzeige -->
      <div class="score-area">
        <strong>Ergebnis Schoet:</strong> <span id="_ergebnisSchoet">0.0</span><br />
        <strong>Ergebnis Meter:</strong> <span id="_ergebnisMeter">0</span>
      </div>
      `;
    }
    
    /******** Event-Listener & Funktionen der Original-Oberfläche ********/
    // Hier nutzen wir weitgehend den Original-Code (wie von dir gesendet) – die IDs werden dabei mit dem Gruppen-Prefix ergänzt.
    function setupScoreboardListeners(groupId) {
      const topTeam = document.getElementById(`_topTeam`);
      const bottomTeam = document.getElementById(`_bottomTeam`);
    
      const topTeamToggleBtn = document.getElementById(`_topTeamToggleBtn`);
      const bottomTeamToggleBtn = document.getElementById(`_bottomTeamToggleBtn`);
    
      const topSchoetBtn = document.getElementById(`_topSchoetBtn`);
      const bottomSchoetBtn = document.getElementById(`_bottomSchoetBtn`);
    
      const topSchoetDisplay = document.getElementById(`_topSchoetDisplay`);
      const bottomSchoetDisplay = document.getElementById(`_bottomSchoetDisplay`);
    
      const topMeterInput = document.getElementById(`_topMeterInput`);
      const bottomMeterInput = document.getElementById(`_bottomMeterInput`);
    
      const ergebnisSchoet = document.getElementById(`_ergebnisSchoet`);
      const ergebnisMeter = document.getElementById(`_ergebnisMeter`);
    
      const genderSelect = document.getElementById("genderSelect");
      const resetBtn = document.getElementById("resetBtn");
    
      let topSchoet = 0;
      let bottomSchoet = 0;
    
      topTeamToggleBtn.addEventListener("click", () => {
        if (topTeam.classList.contains("red")) {
          topTeam.classList.remove("red");
          topTeam.classList.add("green");
        } else {
          topTeam.classList.remove("green");
          topTeam.classList.add("red");
        }
        if (bottomTeam.classList.contains("green")) {
          bottomTeam.classList.remove("green");
          bottomTeam.classList.add("red");
        } else {
          bottomTeam.classList.remove("red");
          bottomTeam.classList.add("green");
        }
        calculateResult();
      });
    
      bottomTeamToggleBtn.addEventListener("click", () => {
        if (bottomTeam.classList.contains("green")) {
          bottomTeam.classList.remove("green");
          bottomTeam.classList.add("red");
        } else {
          bottomTeam.classList.remove("red");
          bottomTeam.classList.add("green");
        }
        if (topTeam.classList.contains("red")) {
          topTeam.classList.remove("red");
          topTeam.classList.add("green");
        } else {
          topTeam.classList.remove("green");
          topTeam.classList.add("red");
        }
        calculateResult();
      });
    
      topSchoetBtn.addEventListener("click", () => {
        topSchoet++;
        topSchoetDisplay.textContent = topSchoet;
        calculateResult();
      });
    
      bottomSchoetBtn.addEventListener("click", () => {
        bottomSchoet++;
        bottomSchoetDisplay.textContent = bottomSchoet;
        calculateResult();
      });
    
      topMeterInput.addEventListener("input", calculateResult);
      bottomMeterInput.addEventListener("input", calculateResult);
    
      function calculateResult() {
        let meterDiff = parseInt(topMeterInput.value) - parseInt(bottomMeterInput.value);
        let schoeetDiff = topSchoet - bottomSchoet;
        let gender = genderSelect.value;
        let threshold = (gender === "men") ? 150 : 100;
    
        let absMeterDiff = Math.abs(meterDiff);
        let extraSchoet = Math.floor(absMeterDiff / threshold);
    
        if (meterDiff > 0) {
          schoeetDiff += extraSchoet;
          meterDiff = meterDiff % threshold;
        } else if (meterDiff < 0) {
          schoeetDiff -= extraSchoet;
          let leftover = absMeterDiff % threshold;
          meterDiff = -leftover;
        }
        
        if (bottomTeam.classList.contains("green") && schoeetDiff > 0) {
          schoeetDiff -= 0.5;
        } else if (topTeam.classList.contains("green") && schoeetDiff < 0) {
          schoeetDiff += 0.5;
        }
    
        ergebnisSchoet.textContent = schoeetDiff.toFixed(1);
        ergebnisMeter.textContent = meterDiff.toFixed(0);
        saveState();
      }
    
      resetBtn.addEventListener("click", () => {
        document.querySelectorAll('tbody input[type="text"]').forEach(input => {
          input.value = "";
        });
        document.querySelectorAll('tbody input[type="checkbox"]').forEach(checkbox => {
          checkbox.checked = false;
        });
        topSchoet = 0;
        bottomSchoet = 0;
        topSchoetDisplay.textContent = 0;
        bottomSchoetDisplay.textContent = 0;
        topMeterInput.value = 0;
        bottomMeterInput.value = 0;
        document.getElementById(`_topVerein`).value = "";
        document.getElementById(`_bottomVerein`).value = "";
        ergebnisSchoet.textContent = "0.0";
        ergebnisMeter.textContent = "0";
        genderSelect.value = "men";
        topTeam.classList.remove("green");
        topTeam.classList.add("red");
        bottomTeam.classList.remove("red");
        bottomTeam.classList.add("green");
        saveState();
      });
    
      // Speichert den aktuellen Zustand in Firebase
      function saveState() {
        const state = {
          topTeam: {
            verein: document.getElementById(`_topVerein`).value,
            schoet: topSchoet,
            meter: Number(topMeterInput.value),
            leadership: topTeam.classList.contains("green"),
          },
          bottomTeam: {
            verein: document.getElementById(`_bottomVerein`).value,
            schoet: bottomSchoet,
            meter: Number(bottomMeterInput.value),
            leadership: bottomTeam.classList.contains("green"),
          }
        };
        db.ref('competitions/' + compId + '/groups/' + groupId + '/scoreboard').set(state);
      }
    }
    
    /******** Firebase-Live-Listener und Summary ********/
    function setupFirebaseListeners() {
      groups.forEach(g => {
        db.ref('competitions/' + compId + '/groups/' + g.id + '/scoreboard').on('value', snapshot => {
          const state = snapshot.val();
          if (state) {
            if (!groupStates[g.id]) groupStates[g.id] = {};
            groupStates[g.id].scoreboard = state;
            if (g.id === selectedGroup) {
              // Aktualisiere die lokale UI (nur die Zahlen, Verein etc.)
              updateScoreboardUI(selectedGroup, state);
            }
            updateSummary();
          }
        });
      });
    }
    
    function updateScoreboardUI(groupId, state) {
      // Update OBEN
      document.getElementById(`_topVerein`).value = state.topTeam.verein;
      document.getElementById(`_topSchoetDisplay`).textContent = state.topTeam.schoet;
      document.getElementById(`_topMeterInput`).value = state.topTeam.meter;
      // Update UNTEN
      document.getElementById(`_bottomVerein`).value = state.bottomTeam.verein;
      document.getElementById(`_bottomSchoetDisplay`).textContent = state.bottomTeam.schoet;
      document.getElementById(`_bottomMeterInput`).value = state.bottomTeam.meter;
    }
    
    function updateSummary() {
      let html = "<div class='groupHeader'>Ergebnisse aller Gruppen:</div>";
      groups.forEach(g => {
        if (groupStates[g.id] && groupStates[g.id].scoreboard) {
          const state = groupStates[g.id].scoreboard;
          let diff = state.topTeam.schoet - state.bottomTeam.schoet;
          let meterDiff = state.topTeam.meter - state.bottomTeam.meter;
          // Führung anpassen:
          if (state.bottomTeam.leadership && diff > 0) { diff -= 0.5; }
          else if (state.topTeam.leadership && diff < 0) { diff += 0.5; }
          let führer = "";
          if (state.topTeam.schoet > state.bottomTeam.schoet) {
            führer = state.topTeam.verein || "Team OBEN";
          } else if (state.topTeam.schoet < state.bottomTeam.schoet) {
            führer = state.bottomTeam.verein || "Team UNTEN";
          } else {
            führer = "gleichstand";
          }
          html += `<div>: Schoet Differenz  / Meter . Führung: </div>`;
        } else {
          html += `<div>: keine Daten</div>`;
        }
      });
      summaryContainer.innerHTML = html;
    }
    
    /******** Initialisierung ********/
    // Render die detaillierte Ansicht der Standardgruppe
    renderDetailedView(selectedGroup);
    // Starte Firebase-Live-Listener
    setupFirebaseListeners();
  </script>
</body>
</html>